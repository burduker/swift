:ruby
  pages = Page.published.all( :parent => from, :order => :priority.desc)
  len = pages.length
  k = 1
  tree = []

  pages.each do |page|
    ensued = @swift[:path_ids].include? page.id
    master = level == 0

    leaf = {}
    leaf[:title] = page.title
    leaf[:href] = page.path

    leaf[:class] = master ? 'm' : 's'
    if ensued
      leaf[:class] += master ? ' ma' : ' sa'
    end

    child = false
    if ensued || @opts[:expand]
      child = partial @recursive, :locals => { :from => page, :level => level + 1, :prefix => prefix + '/' + page.slug }
    end

    if child
      leaf[:class] += master ? ' mo' : ' so'
      leaf[:child] = child
    else
      leaf[:class] += ensued && !master ? ' la' : ''
    end

    leaf[:class] += ' first'  if k == 1
    leaf[:class] += ' last'   if k == len

    k += 1
    tree << leaf
  end

  return tree.length > 0 ? tree : false
